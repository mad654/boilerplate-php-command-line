#!/usr/bin/env php

<?php

$root = realpath(__DIR__ . '/../');
require "$root/vendor/autoload.php";

use Monolog\Logger;
use Psr\Log\LoggerInterface;
use Symfony\Component\Console\Application;

function main($root) {
    configureRequiredEnv($root);
    $appName = getenv('APP_NAME');
    $logger = configureLogging($root, $appName);

    $app = new Application();
    $app->setName($appName);
    $app->addCommands(getCommands($root, $logger));
    $app->run();
}

/**
 *
 * Wrapped in function to deny access on $app
 * and other environment
 *
 * @param string $root root directory
 * @return \Symfony\Component\Console\Command\Command[]
 */
function getCommands($root, LoggerInterface $logger) {
    $commands = include "$root/etc/commands.inc.php";
    return $commands;
}

/**
 * @param string $root
 */
function configureRequiredEnv($root) {
    $config = new Dotenv\Dotenv("$root/etc", 'config');
    $config->load();
    $config->required('APP_NAME');

    include "$root/etc/config_requirements.inc.php";
}

/**
 * @param string $root
 * @param string $name
 * @return Logger
 */
function configureLogging($root, $name) {
    $logger = new Logger($name);
    "$root/etc/logging.inc.php";
    return $logger;
}

main($root);
